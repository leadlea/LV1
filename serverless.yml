service: ai-levels-backend

provider:
  name: aws
  runtime: python3.12
  region: ap-northeast-1
  environment:
    RESULTS_TABLE: ai-levels-results
    PROGRESS_TABLE: ai-levels-progress
    BEDROCK_MODEL_ID: global.anthropic.claude-sonnet-4-6
    PASS_THRESHOLD_LV1: "30"
    PASS_THRESHOLD_LV2: "30"
    PASS_THRESHOLD_LV3: "30"
    PASS_THRESHOLD_LV4: "30"
  timeout: 60
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Query
          Resource:
            - !GetAtt ResultsTable.Arn
            - !GetAtt ProgressTable.Arn
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource: "*"
        - Effect: Allow
          Action:
            - aws-marketplace:ViewSubscriptions
            - aws-marketplace:Subscribe
          Resource: "*"

functions:
  generate:
    handler: backend/handlers/generate_handler.handler
    events:
      - http:
          path: lv1/generate
          method: post
          cors: true
  grade:
    handler: backend/handlers/grade_handler.handler
    events:
      - http:
          path: lv1/grade
          method: post
          cors: true
  complete:
    handler: backend/handlers/complete_handler.handler
    events:
      - http:
          path: lv1/complete
          method: post
          cors: true
  gate:
    handler: backend/handlers/gate_handler.handler
    events:
      - http:
          path: levels/status
          method: get
          cors: true

  lv2Generate:
    handler: backend/handlers/lv2_generate_handler.handler
    events:
      - http:
          path: lv2/generate
          method: post
          cors: true
  lv2Grade:
    handler: backend/handlers/lv2_grade_handler.handler
    events:
      - http:
          path: lv2/grade
          method: post
          cors: true
  lv2Complete:
    handler: backend/handlers/lv2_complete_handler.handler
    events:
      - http:
          path: lv2/complete
          method: post
          cors: true

  lv3Generate:
    handler: backend/handlers/lv3_generate_handler.handler
    events:
      - http:
          path: lv3/generate
          method: post
          cors: true
  lv3Grade:
    handler: backend/handlers/lv3_grade_handler.handler
    events:
      - http:
          path: lv3/grade
          method: post
          cors: true
  lv3Complete:
    handler: backend/handlers/lv3_complete_handler.handler
    events:
      - http:
          path: lv3/complete
          method: post
          cors: true

  lv4Generate:
    handler: backend/handlers/lv4_generate_handler.handler
    events:
      - http:
          path: lv4/generate
          method: post
          cors: true
  lv4Grade:
    handler: backend/handlers/lv4_grade_handler.handler
    events:
      - http:
          path: lv4/grade
          method: post
          cors: true
  lv4Complete:
    handler: backend/handlers/lv4_complete_handler.handler
    events:
      - http:
          path: lv4/complete
          method: post
          cors: true

resources:
  Resources:
    ResultsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ai-levels-results
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
    ProgressTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ai-levels-progress
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
